<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/project/css/themes/default/style.min.css">
<style>
.doc-sidebar {
	position: relative;
	display: flex;
	flex-direction: column;
	height: 100%;
}

.doc-wrapper {
	height: 1000px;
	border-right: 1px solid #dfe5ef;
}

.right-wrapper{
	height: 1000px;
	border-right: 1px solid #dfe5ef;
	padding-right: 30px;
}

.custom-btn {
	background-color: #eaeef5;
	color: #3b4e6d;
	border: 1px solid #b9bec5;
	transition: background-color 0.3s ease;
}

.custom-btn:hover {
	background-color: #c7d3e0;
	border-color: #c7d3e0;
	color: white;
}
#docUpdateBtn{
	border-color: black;
	padding: 5px;
	padding-bottom: 3px; 
	padding-top: 3px; 
}

#listContainer table {
	border-collapse: collapse;
	width: 100%;
}


#listContainer th {
	border-bottom: 1px solid black;
}

#listContainer tbody tr:last-child td {
	border-bottom: 1px solid black;
}

#listContainer table th, #listContainer table td {
	padding: 10px;
}

#listContainer table th {
	border-top: 1px solid black;
	border-bottom: 1px solid black;
}

#listContainer table tbody tr:last-child td {
	border-bottom: none; 
}
</style>
<header>
	<div class="container-fluid">
		<h4>문서 양식 관리</h4>
		<hr>
	</div>
</header>
<!-- 메인 컨텐츠 -->
<div class="container-fluid">
	<div class="row">
		<!-- 왼쪽 사이드바 -->
		<div class="col-lg-2 col-md-4">
			<div class="doc-wrapper">
				<div class="left-part border-end w-15 flex-shrink-0 d-none d-lg-block"></div>
				<div class="doc-sidebar">
					<!-- 검색 입력 창 -->
					<div class="searchInput d-flex align-items-center me-3">
						<input type="text" id="schName" class="form-control rounded-0" maxlength="20" placeholder="검색">
						<button type="button" class="btn btn-dark bg-dark rounded-0" onclick="fSch()">
							<i class="fa-light fa-magnifying-glass fa-md fa-fw"></i>
						</button>
					</div>
					<!-- 트리 -->
					<div id="tree" style="margin-top: 20px;"></div>
					<div class="simplebar-track simplebar-vertical" style="visibility: visible;">
						<div class="simplebar-scrollbar" style="height: 681px; transform: translate3d(0px, 0px, 0px); display: block;"></div>
					</div>
				</div>
			</div>
		</div>
		<!-- 오른쪽 컨텐츠 -->
		<div class="col-lg">
			<div class="row">
				<div class="col">
					<div class="right-wrapper">
						<div class="buttonWrpper d-flex justify-content-end">
							<div class="buttonWrapper__item me-2">
								<button class="btn btn-rounded custom-btn" id="docInsertBtn">양식 추가</button>
							</div>
							<div class="buttonWrapper__item me-2">
								<button class="btn btn-rounded custom-btn" id="docModifyBtn">수정</button>
							</div>
							<div class="buttonWrapper__item">
								<button class="btn btn-rounded custom-btn" id="docDeleteBtn">삭제</button>
							</div>
						</div>
						<div class="mt-4" id="selectedFolderInfo">
							<p>
								<span id="selectedFolderName"></span>
							</p>
						</div>
						<div id="listContainer"></div>
					</div>
				</div>
				<div class="col">
					<h4 id="seletedFormName"></h4>
					<div id="docContent"></div>
				</div>
			</div>
		</div>
	</div>
</div>




<script src="${pageContext.request.contextPath }/resources/project/js/source/jstree.min.js"></script>
<%-- <script src="${pageContext.request.contextPath }/vendor/libs/bootstrap-table/dist/bootstrap-table.min.js"></script> --%>

<script type="text/javascript">
$(document).ready(function() {
	var docInsertBtn = $('#docInsertBtn');
	var docModifyBtn = $('#docModifyBtn');
	var docDeleteBtn = $('#docDeleteBtn');
	var selectAllCheckbox = $('#selectAllCheckbox');
	var checkboxes = $('#listContainer').find('input[name="selectedDocuments"]');
	var schName = $('#schName');
	var docContent = $('#docContent');
	var seletedFormName = $('#seletedFormName');
	var selectedInfo = [];
    // 전체 선택/해제 체크박스 클릭 이벤트
    $(document).on('change', '#selectAllCheckbox', function() {
    	$('.doc-chkbox').prop('checked', $(this).prop('checked'));
	});
    
    
    $(document).on('click', '#formSaveBtn', function(){
    	// 폼에 있는 값 가져오기
        var folderSelect = $('#folderSelect').val(); // 선택된 폴더명
        var formTitle = $('#formTitle').val(); // 양식 제목
        var useYn = $('#useYnCheckbox').prop('checked') ? 'Y' : 'N'; // 사용 여부 체크
        var docNo = selectedInfo[0].docNo;
        
        // 폼에 있는 값들을 객체로 만들어 서버에 전송
        var formData = {
            docTypeCode: folderSelect,
            docNm: formTitle,
            useYn: useYn,
            docNo: docNo
        };
        console.log(formData);
        
        Swal.fire({
            text: '저장 하시겠습니까?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '저장',
            cancelButtonText: '취소'
        }).then((result) => {
            if (result.isConfirmed) {
                // 사용자가 확인을 눌렀을 때 AJAX 요청 보내기
                $.ajax({
                    url: '/documents/updateDocForm',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(formData),
                    success: function(res) {
                        console.log('저장 성공!');
                        console.log('res:', res);
                        showToast('성공적으로 저장되었습니다!', 'success');
                    },
                    error: function(xhr, status, error) {
                        console.log('저장 실패');
                    }
                });
            }
        });
    });
    
    
    $(document).on('click', '.doc-chkbox', function() {
    	console.log('체크');
    	
    	
	});
    
    docModifyBtn.click(function() {
        // 체크된 체크박스들을 확인하여 정보 저장
        selectedInfo = [];
        $('.doc-chkbox:checked').each(function() {
            var row = $(this).closest('tr');
            var title = row.find('td:nth-child(2)').text();  // 양식제목
            var emplNm = row.find('td:nth-child(3)').text(); // 최종 수정자
            var useYn = row.find('td:nth-child(4)').text(); // 사용 여부
            var docNo = row.find('.doc-chkbox').val();
            selectedInfo.push({
            	title: title,
                emplNm: emplNm,
                useYn: useYn,
                docNo: docNo
            });
            console.log("수정버튼 눌렀을때 인포:",selectedInfo);
        });

        // 선택된 정보를 옆에 그려주는 함수 호출
        drawSelectedInfo(selectedInfo);
    });
    
    
	loadDocData();
	
	docInsertBtn.click(function(){ 
		window.location.href = "${pageContext.request.contextPath}/documents/insertdocform"; 
	});
	
	
    
    $('#tree').on('select_node.jstree', function(e, data) {
    	var selectedNode = data.node; // 선택된 노드 가져오기
    	var parentText = selectedNode.parent === "#" ? selectedNode.text : $('#tree').jstree(true).get_node(selectedNode.parent).text; // 부모 노드의 텍스트 가져오기
        
        $('#selectedFolderName').text('폴더명: '+parentText);
        var childNodes = selectedNode.children_d; // 선택된 노드의 자식 노드 ID 배열 가져오기
        console.log('####selectedNode', selectedNode);
        console.log('####childNodes', childNodes);
        if (childNodes.length > 0) { // 자식 노드가 있는 경우에만 처리
            var listHtml = '<table style="border-collapse: collapse; width: 100%;">';
            
            listHtml += '<thead><tr><th><input type="checkbox" class="form-check-input primary" id="selectAllCheckbox"></th><th>제목</th><th>최종 수정자</th><th>사용여부</th></tr></thead>';
            listHtml += '<tbody>';
            childNodes.forEach(function(childNodeId) { // 각 자식 노드에 대해 처리
                var childNode = $('#tree').jstree(true).get_node(childNodeId); // 자식 노드 가져오기
                var docCn = childNode.original.docCn; // 원본 데이터에서 docCn 가져오기
                var emplNm = childNode.original.emplNm;
                var useYn = childNode.original.useYn; 
	                if (useYn === 'Y') { 
	                    useYn = "사용";
	                } else { 
	                    useYn = "사용 안함";
	                }
	                listHtml += '<tr>';
	                listHtml += '<td><input type="checkbox" class="form-check-input doc-chkbox primary" value="' + childNode.id + '"></td>';
	                listHtml += '<td class="form-title">' + childNode.text + '</td>';
	                listHtml += '<td>' + emplNm + '</td>';
	                listHtml += '<td>' + useYn + '</td>'; 
	                listHtml += '</tr>';
            });
            listHtml += '</tbody></table>';

            $('#listContainer').html(listHtml); // #listContainer에 추가
        }
    });
});

function drawSelectedInfo(selectedInfo) {
	var docContent = $('#docContent');
    docContent.html('');
    var html = '';
    $('#seletedFormName').text('문서 양식 수정');
    // 폴더 제목 가져오기
    var folderNameText = $('#selectedFolderName').text();
    var folderName = folderNameText.split(': ')[1];
	var btnHtml = '';
    selectedInfo.forEach(function(info) {
    	html += '<table class="table">';
    	html += '<form id="updateForm">';
    	html += '<tr>';
        html += '<td><strong>폴더명: </strong><select class="form-select folder-select" id="folderSelect">';
        html += '<option value="F101" ' + (folderName === '일반' ? 'selected' : '') + '>일반</option>';
        html += '<option value="F102" ' + (folderName === '지원' ? 'selected' : '') + '>지원</option>';
        html += '<option value="F103" ' + (folderName === '인사' ? 'selected' : '') + '>인사</option>';
        html += '<option value="F104" ' + (folderName === '휴가' ? 'selected' : '') + '>휴가</option>';
        html += '</select></td>';
        html += '</tr>';
        html += '<tr>';
        html += '<input type="hidden" id="FormDocCn" val="'+info.docNo+'">';
        html += '<td><strong>양식 제목: </strong><input type="text" class="form-control" id="formTitle" value="' + info.title + '"></td>';
        html += '</tr>';
        html += '<tr>';
        html += '<td><strong>최종 수정자: </strong>' + info.emplNm + '</td>';
        html += '</tr>';
        html += '<tr>';
        html += '<td><strong>양식 편집: </strong> <button class="btn btn-rounded btn-light ms-2" id="docUpdateBtn">양식 편집</button> </td>';
        html += '</tr>';
        html += '<tr>'; 
        html += '<td><strong>사용 여부: </strong><input type="checkbox" id="useYnCheckbox" class="form-check-input primary" ' + (info.useYn === '사용' ? 'checked' : '') + '></td>';
        html += '</tr>';
        html += '</form>';
        html += '</table>';
    });

    docContent.html(html);
    btnHtml += '<div style="text-align: center;">';
    btnHtml += '<button class="btn btn-rounded btn-light me-3" id="formCancelBtn">취소</button>';
    btnHtml += '<button class="btn btn-rounded btn-primary" id="formSaveBtn">저장</button>';
    btnHtml += '</div>';

    docContent.append(btnHtml);
    
}

function selectDocumentsList(){
	$.ajax({
		url: "/documents/doclist",
		type: "get",
		async: false
	})
	.done(function(res){
		
	})
}


function loadDocData() {
    $.ajax({
        url: "/documents/selectdoclist",
        type: "GET",
        dataType: "json",
        success: function(documentsList) {
        	
            // 서버에서 전달받은 JSON 데이터 사용
            var treeData = convertToJstreeFormat(documentsList);
            // jstree 초기화
            $('#tree').jstree({
                "plugins": ["search", "wholerow"],
                "search": {
                    "show_only_matches": true,
                    "show_only_matches_children": true,
                },
                'core': {
                    'data': treeData
                }
            });
        }
    });
}


function fSch() {
    console.log("껌색할께영");
    $('#tree').jstree(true).search($("#schName").val());
}

// jstree의 형식으로 변환
function convertToJstreeFormat(documentsList) {
	var treeData = [];
	for (var i = 0; i < documentsList.length; i++) {
		var document = documentsList[i];
		
		treeData.push({
			"id" : document.id,
			"text" : document.text,
			"parent" : document.parent,
			"docCn" : document.docCn,
			"emplNm" : document.emplNm,
			"useYn"	: document.useYn
			
		});
	}
	console.log('############TreeDATA',treeData);
	return treeData;
}
</script>
</html>