<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<style>
.legend-item {
    display: inline-block;
    margin-right: 20px;
}
.color-box {
    display: inline-block;
    width: 15px;
    height: 15px;
    margin-right: 5px;
}
.reserved {
    background-color: #808080; /* 회색 */
}
.my-reservation {
    background-color: #00BFFF; /* 하늘색 */
}
/* 모든 input 필드에 적용되는 스타일 */
#reservationForm input {
    border: none; /* 테두리 제거 */
    background: transparent; /* 배경색 투명 */
}

/* 일정 이름 필드 스타일 재정의 */
#reservationForm input#title {
    border: 1px solid #ccc; /* 테두리를 회색으로 설정 */
    background: white; /* 배경색을 흰색으로 설정 */
}

</style>
<div class="card">
			<div class="row gx-0">
				<div class="calendar-header">
	    			<div id="legend">
				        <span class="legend-item"><span class="color-box reserved"></span>예약됨</span>
				        <span class="legend-item"><span class="color-box my-reservation"></span>나의 예약</span>
	    			</div>
				</div>
			
			<div class="col-lg-2">
				<div class="p-4 calendar-sidebar">
					<ul class="nav flex-column">
						<li class="nav-item">
							<a href="#" class="nav-link" id="all-resources">전체설비</a>
							<ul class="submenu">
								<li><a href="#" class="nav-link" id="meeting-rooms">회의실</a></li>
								<li><a href="#" class="nav-link" id="vehicles">차량</a></li>
								<li><a href="#" class="nav-link" id="supplies">비품</a></li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
			<div class="col-lg-10">
				<div class="p-4 calender-sidebar app-calendar">
					<div id="calendar"></div>
				</div>
			</div>
		</div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">일정 추가하기</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
				<form id="reservationForm">
					<div class="modal-body">
						예약할자원:
						  <input type="text" id="resourceName" readonly="readonly">
                    	  <input type="hidden" id="mtngRoomNo" name="mtngRoomNo">
						<br>
						일정이름 :
						<input type="text" id="title"  name="resveCn"/>
						<br /> 시작시간 :
						<input  id="start" name="resveBeginDt" />
						<br /> 종료시간 :
						<input  id="end" name="resveEndDt"/>
						<br>
						예약자:
						<input type="text" id="loggedInUserName" value="${user.emplNm}" readonly="readonly" />
						<input type="hidden" id="loggedInUserNo" name="emplNo" value="${user.emplNo}" />
					</div>
				</form>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
				<button type="button" class="btn btn-primary" id="saveChanges">신청</button>
			</div>
		</div>
	</div>
</div>
<!-- Modal END -->
<%-- <script src="${pageContext.request.contextPath }/resources/project/js/sweetalert_custom.js"></script> --%>
<%-- <script src="${pageContext.request.contextPath }/resources/project/js/source/index.global.min.js"></script> --%>
 <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>
 
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar;

    // 자원 목록
    const resourcesForRooms = [
        { id: '1', title: '제 1회의실' },
        { id: '2', title: '제 2회의실' },
        { id: '3', title: '제 3회의실' },
        { id: '4', title: '제 4회의실' },
        { id: '5', title: '제 5회의실' }
    ];
    const resourcesForVehicles = [
        { id: '6', title: '차량 A' },
        { id: '7', title: '차량 B' },
        { id: '8', title: '차량 C' },
        { id: '9', title: '차량 D' },
        { id: '10', title: '차량 E' }
    ];
    const resourcesForSupplies = [
        { id: '11', title: '프로젝터1' },
        { id: '12', title: '프로젝터2' },
        { id: '13', title: '프로젝터3' },
        { id: '14', title: '노트북1' },
        { id: '15', title: '노트북2' },
        { id: '16', title: '노트북3' },
    ];

    // 캘린더 설정 및 렌더링 함수
    function setupCalendar(resources) {
        if (calendar) {
            calendar.destroy(); // 이전 캘린더 인스턴스 제거
        }
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'resourceTimelineDay',
            height: '700px',
            expandRows: true,
            slotMinTime: '09:00',
            slotMaxTime: '22:00',
            slotDuration: '00:30:00',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'resourceTimelineDay',
            },
            locale: 'ko',
            selectable: true,
            selectMirror: true,
            navLinks: true,
            editable: true,
            dayMaxEventRows: true,
            nowIndicator: true,
            resources: resources,
            select: function(arg) {
                $('#start').val(formatDateToCustomFormat(arg.startStr));
                $('#end').val(formatDateToCustomFormat(arg.endStr));
                $('#resourceName').val(arg.resource.title);
                $('#mtngRoomNo').val(arg.resource.id);
                $('#exampleModal').modal('show');
                calendar.unselect();
            }
        });
        calendar.render();
    }

    // 이벤트 핸들러 등록
    document.getElementById('meeting-rooms').addEventListener('click', function() {
        setupCalendar(resourcesForRooms);
    });
    document.getElementById('vehicles').addEventListener('click', function() {
        setupCalendar(resourcesForVehicles);
    });
    document.getElementById('supplies').addEventListener('click', function() {
        setupCalendar(resourcesForSupplies);
    });
});

//날짜 포맷 함수: Date 객체를 'YYYY-MM-DD HH24:MI' 형식의 문자열로 변환
function formatDateToCustomFormat(date) {
    var d = new Date(date);
    var year = d.getFullYear();
    var month = ('0' + (d.getMonth() + 1)).slice(-2);
    var day = ('0' + d.getDate()).slice(-2);
    var hour = ('0' + d.getHours()).slice(-2);
    var minute = ('0' + d.getMinutes()).slice(-2);
    return `\${year}-\${month}-\${day} \${hour}:\${minute}`;
}

document.getElementById('saveChanges').addEventListener('click', function() {
// AJAX 요청 설정
	var formData = {
        mtngRoomNo: document.getElementById('mtngRoomNo').value,
        resveCn: document.getElementById('title').value,
        resveBeginDt: formatDateToCustomFormat(document.getElementById('start').value),
        resveEndDt: formatDateToCustomFormat(document.getElementById('end').value),
        emplNo: document.getElementById('loggedInUserNo').value
    };

	    $.ajax({
	        url: '/addReservation',
	        type: 'POST',
	        processData: false,  // FormData를 사용할 때는 processData와 contentType을 false로 설정
	        contentType: "application/json;charset=utf-8",
	        data: JSON.stringify(formData),
	        beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			},
	        success: function(response) {
	            $('#exampleModal').modal('hide');
	            alert("예약이 성공적으로 등록되었습니다.");
	            // 성공 후 페이지를 새로고침하거나 목록을 업데이트할 수 있습니다.
	        },
	        error: function(xhr, status, error) {
	            alert("예약 등록에 실패했습니다. 오류: " + error);
	        }
	    });
});


</script>
